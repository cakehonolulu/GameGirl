#include <cb_opcodes.h>

const struct m_sharp_lr35902_instr_cb m_gb_instr_cb[256] = {
	{NULL, NULL},							// 0x00
	{NULL, NULL},                           // 0x01
	{NULL, NULL},                           // 0x02
	{NULL, NULL},                           // 0x03
	{NULL, NULL},                           // 0x04
	{NULL, NULL},                           // 0x05
	{NULL, NULL},                           // 0x06
	{NULL, NULL},                           // 0x07
	{NULL, NULL},                           // 0x08
	{NULL, NULL},                           // 0x09
	{NULL, NULL},                           // 0x0A
	{NULL, NULL},                           // 0x0B
	{NULL, NULL},                           // 0x0C
	{NULL, NULL},                           // 0x0D
	{NULL, NULL},                           // 0x0E
	{NULL, NULL},                           // 0x0F
	{NULL, NULL},                           // 0x10
	{"RL C", m_rl_c},                       // 0x11
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{"BIT 7, H", m_bit_7_h},				// 0x7C
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},							// 0x7C
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL},                           // 0x00
	{NULL, NULL}                           	// 0x00
};

void m_cb_ext(uint8_t cb_instr)
{
#ifdef OPCODE_DEBUG
	printf("CB Mode Instr!\n");

	printf("Current CB Opcode: 0x%02X\n", cb_instr);
#endif

	if (m_gb_instr_cb[cb_instr].m_funct == NULL)
	{
		printf("Unimplemented Opcode: 0xCB%02X\n", cb_instr);
		m_printregs();
		exit(EXIT_FAILURE);
	} else {
		((void (*)(void))m_gb_instr_cb[cb_instr].m_funct)();
	}
}

/*
	RL C
	Opcode: 0xCB11
	Number of Bytes: 2
	Number of Cycles: 2

	Rotate the contents of register C to the left.
	That is, the contents of bit 0 are copied to bit 1, and
	the previous contents of bit 1 (before the copy operation)
	are copied to bit 2. The same operation is repeated in sequence
	for the rest of the register. The previous contents of the carry
	(CY) flag are copied to bit 0 of register C.
*/
void m_rl_c()
{
#ifdef OPCODE_DEBUG
	printf("\033[1;31mRL C\033[1;0m\n");
#endif

	uint8_t carry = FLAG_CHECK(CRRY) ? 1 : 0;

	if (carry)
	{
		FLAG_SET(CRRY);
	} else {
		FLAG_UNSET(CRRY);
	}

	C <<= 1;
	C += carry;
	
	if(C)
	{
		FLAG_UNSET(ZERO);
	} else {
		FLAG_SET(ZERO);
	}
	
	FLAG_UNSET(NGTV | HALF);
	
	PC += 2;
}

/*
	BIT 7, H
	Opcode: 0xCB7C
	Number of Bytes: 2
	Number of Cycles: 2

	Copy the complement of the contents of bit 7 in register H
	to the Z flag of the program status word (PSW).
*/
void m_bit_7_h()
{
	if (BIT_CHECK(H, 7))
	{
		FLAG_UNSET(ZERO);
	} else {
		FLAG_SET(ZERO);
	}

	FLAG_UNSET(NGTV);

	FLAG_SET(HALF);

#ifdef OPCODE_DEBUG
	printf("Flags: 0x%02X\n", FLAGS);
#endif
	PC += 2;
}
